name: Build & Test (Cost-Optimized)

on:
  pull_request:
    branches: [ main, dev ]
  push:
    branches: [ main, dev ]

jobs:
  build-and-test:
    name: Build and Run Tests
    runs-on: macos-14
    
    strategy:
      matrix:
        xcode-version: ['16.2']
        destination: ['platform=iOS Simulator,name=iPhone 16']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode-version }}.app/Contents/Developer
          xcode-select -p
          xcodebuild -version
      
      - name: Cache Derived Data
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            .build
          key: ${{ runner.os }}-derived-data-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-derived-data-
      
      - name: Build for testing
        run: |
          cd Pettio.IOS
          xcodebuild \
            -scheme Pettio.IOS \
            -destination '${{ matrix.destination }}' \
            -configuration Debug \
            clean build
        continue-on-error: false
      
      - name: Run unit tests
        run: |
          cd Pettio.IOS
          xcodebuild \
            -scheme Pettio.IOS \
            -destination '${{ matrix.destination }}' \
            -configuration Debug \
            test
        continue-on-error: false

  # ⚠️ DISABLED FOR COST OPTIMIZATION
  # The following jobs have been disabled to significantly reduce GitHub Actions costs:
  # - code-quality: Expensive find/grep operations on all Swift files
  # - lint-check: Additional style and documentation checks
  #
  # Re-enable these jobs when GitHub Actions budget allows by creating new workflow files
  # or by uncommenting the original workflows from git history.