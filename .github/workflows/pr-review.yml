name: PR Review

on:
  pull_request:
    branches: [ main, dev ]
    types: [ opened, synchronize, reopened ]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          echo "Validating PR Title: $PR_TITLE"
          echo "==============================="
          
          # Check if PR title follows conventional commits
          if [[ $PR_TITLE =~ ^(feat|fix|docs|style|refactor|test|chore|ci)(\(.+\))?!?:\ .+ ]]; then
            echo "âœ… PR title follows conventional commits format"
          else
            echo "âš ï¸  PR title doesn't follow conventional commits format"
            echo "Expected format: type(scope): description"
            echo "Valid types: feat, fix, docs, style, refactor, test, chore, ci"
            exit 1
          fi
      
      - name: Check PR description
        run: |
          DESCRIPTION="${{ github.event.pull_request.body }}"
          
          if [ -z "$DESCRIPTION" ] || [ ${#DESCRIPTION} -lt 20 ]; then
            echo "âš ï¸  PR description is empty or too short"
            echo "Please provide a detailed description of your changes"
            exit 1
          fi
          
          echo "âœ… PR description is present and detailed"
      
      - name: Check for required labels
        run: |
          LABELS="${{ join(github.event.pull_request.labels.*.name, ', ') }}"
          
          if [ -z "$LABELS" ]; then
            echo "â„¹ï¸  No labels assigned to PR (optional)"
          else
            echo "âœ… Labels assigned: $LABELS"
          fi
      
      - name: Check Git history
        run: |
          echo "ðŸ“ Git History Check:"
          echo "===================="
          
          # Count commits in PR (between base and head SHAs)
          COMMIT_COUNT=$(git rev-list --count ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          echo "Commits in this PR: $COMMIT_COUNT"
          
          if [ $COMMIT_COUNT -gt 10 ]; then
            echo "âš ï¸  PR has many commits ($COMMIT_COUNT). Consider squashing."
          else
            echo "âœ… Commit count is reasonable"
          fi
      
      - name: Generate PR summary
        run: |
          echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… PR Title: Valid" >> $GITHUB_STEP_SUMMARY
          echo "âœ… PR Description: Present" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reviewers should check:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Code follows project conventions" >> $GITHUB_STEP_SUMMARY
          echo "2. Tests are included and passing" >> $GITHUB_STEP_SUMMARY
          echo "3. No breaking changes" >> $GITHUB_STEP_SUMMARY
          echo "4. Documentation is updated" >> $GITHUB_STEP_SUMMARY

